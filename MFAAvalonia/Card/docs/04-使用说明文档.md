# CardGlowRenderer 使用说明文档

> 本文档面向需要在自己项目中使用 `CardGlowRenderer` 控件的开发者，提供完整的 API 说明和使用示例。

## 一、快速开始

### 1.1 基本使用

**XAML**：
```xml
<!-- 1. 添加命名空间 -->
xmlns:card="using:MFAAvalonia.Views.UserControls.Card"

<!-- 2. 使用控件 -->
<card:CardGlowRenderer 
    Source="{Binding CardImage}"
    Width="200" 
    Height="300"
    IsGlowEnabled="True"/>
```

**代码**：
```csharp
// 创建控件
var glowRenderer = new CardGlowRenderer
{
    Width = 200,
    Height = 300,
    Source = myBitmap,
    IsGlowEnabled = true
};

// 应用预设
glowRenderer.ApplyPreset(GlowPreset.GoldRare);
```

### 1.2 最小示例

```xml
<Window xmlns="https://github.com/avaloniaui"
        xmlns:card="using:MFAAvalonia.Views.UserControls.Card">
    <card:CardGlowRenderer 
        Source="/Assets/card.png"
        Width="200" 
        Height="300"/>
</Window>
```

## 二、API 参考

### 2.1 属性

| 属性 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `Source` | `IImage?` | `null` | 卡牌图像源 |
| `Config` | `CardGlowConfig` | `Default` | 流光效果配置 |
| `IsGlowEnabled` | `bool` | `true` | 是否启用流光效果 |

### 2.2 方法

| 方法 | 参数 | 返回值 | 说明 |
|------|------|--------|------|
| `ApplyPreset` | `GlowPreset preset` | `void` | 应用预设配置 |
| `ForceRefresh` | 无 | `void` | 强制刷新渲染 |

### 2.3 预设枚举

```csharp
public enum GlowPreset
{
    Default,        // 默认效果 - 白色流光
    GoldRare,       // 金色稀有卡 - 金色流光
    BlueRare,       // 蓝色稀有卡 - 蓝色流光
    PurpleLegend,   // 紫色传说卡 - 紫色流光 + 强闪烁
    RainbowHolo,    // 彩虹全息卡 - 高强度多彩效果
    Subtle          // 低调效果 - 淡雅流光
}
```

## 三、使用场景

### 3.1 静态绑定

适用于图像不会变化的场景：

```xml
<card:CardGlowRenderer 
    Source="{StaticResource MyCardImage}"
    Config="{StaticResource GoldConfig}"/>
```

### 3.2 动态绑定

适用于图像会变化的场景（如卡牌列表）：

```xml
<ItemsControl ItemsSource="{Binding Cards}">
    <ItemsControl.ItemTemplate>
        <DataTemplate>
            <card:CardGlowRenderer 
                Source="{Binding CardImage}"
                IsGlowEnabled="{Binding IsRare}"/>
        </DataTemplate>
    </ItemsControl.ItemTemplate>
</ItemsControl>
```

### 3.3 代码控制

```csharp
// 切换预设
private void OnRarityChanged(CardRarity rarity)
{
    var preset = rarity switch
    {
        CardRarity.Common => GlowPreset.Subtle,
        CardRarity.Rare => GlowPreset.BlueRare,
        CardRarity.Epic => GlowPreset.PurpleLegend,
        CardRarity.Legendary => GlowPreset.GoldRare,
        _ => GlowPreset.Default
    };
    
    MyGlowRenderer.ApplyPreset(preset);
}

// 动态切换图片
private void OnCardSelected(Bitmap newImage)
{
    MyGlowRenderer.Source = newImage;
}

// 开关流光
private void ToggleGlow(bool enabled)
{
    MyGlowRenderer.IsGlowEnabled = enabled;
}
```

## 四、自定义配置

### 4.1 创建自定义配置

```csharp
var customConfig = new CardGlowConfig
{
    // 亮度检测
    BrightnessThreshold = 0.5f,      // 降低阈值，更多区域发光
    SaturationThreshold = 0.2f,
    
    // 流光效果
    FlowSpeed = 0.8f,                // 加快流光速度
    FlowWidth = 0.4f,                // 加宽流光
    FlowAngle = 0.5f,                // 改变角度
    FlowIntensity = 1.2f,            // 增强强度
    
    // 颜色
    FlowColor = Color.FromRgb(255, 100, 100),  // 红色流光
    SecondaryFlowColor = Color.FromRgb(255, 150, 150),
    
    // 闪烁
    EnableSparkle = true,
    SparkleIntensity = 0.5f,
    SparkleDensity = 0.6f,
    
    // 混合
    BlendMode = 0,                   // Add 模式（更亮）
    OverallIntensity = 1.0f
};

// 应用配置
MyGlowRenderer.Config = customConfig;
```

### 4.2 基于预设修改

```csharp
// 克隆预设并修改
var config = CardGlowConfig.GoldRare.Clone();
config.FlowSpeed = 1.0f;           // 加快速度
config.SparkleIntensity = 0.8f;    // 增强闪烁

MyGlowRenderer.Config = config;
```

### 4.3 配置参数详解

#### 亮度检测参数

| 参数 | 范围 | 默认 | 说明 |
|------|------|------|------|
| `BrightnessThreshold` | 0-1 | 0.65 | 亮度阈值，越低越多区域发光 |
| `SaturationThreshold` | 0-1 | 0.3 | 饱和度阈值 |
| `BrightnessWeight` | 0-1 | 0.7 | 亮度在判断中的权重 |
| `SaturationWeight` | 0-1 | 0.3 | 饱和度在判断中的权重 |

#### 流光效果参数

| 参数 | 范围 | 默认 | 说明 |
|------|------|------|------|
| `FlowSpeed` | 0+ | 0.5 | 流光移动速度 |
| `FlowWidth` | 0-1 | 0.3 | 流光带宽度 |
| `FlowAngle` | 弧度 | 0.785 | 流光角度（π/4 = 45°） |
| `FlowIntensity` | 0-2 | 0.8 | 主流光强度 |
| `SecondaryFlowSpeedMultiplier` | 0+ | 1.5 | 次流光速度倍率 |
| `SecondaryFlowWidthMultiplier` | 0-1 | 0.5 | 次流光宽度倍率 |
| `SecondaryFlowIntensity` | 0-1 | 0.4 | 次流光强度 |

#### 闪烁效果参数

| 参数 | 范围 | 默认 | 说明 |
|------|------|------|------|
| `EnableSparkle` | bool | true | 是否启用闪烁 |
| `SparkleFrequency` | 0+ | 3.0 | 闪烁频率 |
| `SparkleIntensity` | 0-1 | 0.3 | 闪烁强度 |
| `SparkleDensity` | 0-1 | 0.5 | 闪烁点密度 |

#### 颜色参数

| 参数 | 类型 | 默认 | 说明 |
|------|------|------|------|
| `FlowColor` | Color | 白色偏暖 | 主流光颜色 |
| `SecondaryFlowColor` | Color | 淡蓝色 | 次流光颜色 |
| `SparkleColor` | Color | 纯白 | 闪烁点颜色 |
| `EdgeGlowColor` | Color | 淡金色 | 边缘辉光颜色 |

#### 混合参数

| 参数 | 范围 | 默认 | 说明 |
|------|------|------|------|
| `BlendMode` | 0/1/2 | 1 | 0=Add, 1=Screen, 2=Overlay |
| `OverallIntensity` | 0-1 | 1.0 | 整体效果强度 |

## 五、UI 模板示例

### 5.1 卡牌展示模板

```xml
<!-- 单张卡牌展示 -->
<Border Background="#1E1E1E" CornerRadius="8" Padding="10">
    <StackPanel>
        <card:CardGlowRenderer 
            x:Name="CardDisplay"
            Source="{Binding CardImage}"
            Width="200" 
            Height="300"
            IsGlowEnabled="{Binding IsRare}"/>
        
        <TextBlock Text="{Binding CardName}" 
                   HorizontalAlignment="Center"
                   Margin="0,10,0,0"/>
    </StackPanel>
</Border>
```

### 5.2 卡牌列表模板

```xml
<!-- 卡牌列表 -->
<ScrollViewer>
    <ItemsControl ItemsSource="{Binding Cards}">
        <ItemsControl.ItemsPanel>
            <ItemsPanelTemplate>
                <WrapPanel Orientation="Horizontal"/>
            </ItemsPanelTemplate>
        </ItemsControl.ItemsPanel>
        
        <ItemsControl.ItemTemplate>
            <DataTemplate>
                <Border Margin="5" CornerRadius="4">
                    <card:CardGlowRenderer 
                        Source="{Binding Image}"
                        Width="150" 
                        Height="225"
                        IsGlowEnabled="{Binding HasGlow}"/>
                </Border>
            </DataTemplate>
        </ItemsControl.ItemTemplate>
    </ItemsControl>
</ScrollViewer>
```

### 5.3 带控制面板的模板

```xml
<!-- 带预设选择的卡牌展示 -->
<Grid>
    <Grid.RowDefinitions>
        <RowDefinition Height="*"/>
        <RowDefinition Height="Auto"/>
    </Grid.RowDefinitions>
    
    <!-- 卡牌展示 -->
    <card:CardGlowRenderer 
        x:Name="GlowCard"
        Grid.Row="0"
        Source="{Binding CardImage}"
        HorizontalAlignment="Center"
        VerticalAlignment="Center"
        Width="300" 
        Height="450"/>
    
    <!-- 控制面板 -->
    <StackPanel Grid.Row="1" Orientation="Horizontal" 
                HorizontalAlignment="Center" Margin="10">
        <Button Content="金色" Click="OnGoldClick" Margin="5"/>
        <Button Content="蓝色" Click="OnBlueClick" Margin="5"/>
        <Button Content="紫色" Click="OnPurpleClick" Margin="5"/>
        <ToggleSwitch IsChecked="{Binding #GlowCard.IsGlowEnabled}"/>
    </StackPanel>
</Grid>
```

### 5.4 卡牌详情弹窗模板

```xml
<!-- 卡牌详情弹窗 -->
<Window Width="600" Height="500" Title="卡牌详情">
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>
        
        <!-- 左侧：卡牌图片 -->
        <Border Grid.Column="0" Background="#2D2D30" Padding="20">
            <card:CardGlowRenderer 
                Source="{Binding CardImage}"
                Width="250" 
                Height="375"
                Config="{Binding GlowConfig}"/>
        </Border>
        
        <!-- 右侧：卡牌信息 -->
        <StackPanel Grid.Column="1" Margin="20">
            <TextBlock Text="{Binding CardName}" FontSize="24" FontWeight="Bold"/>
            <TextBlock Text="{Binding CardDescription}" TextWrapping="Wrap" Margin="0,10"/>
            
            <!-- 稀有度选择 -->
            <StackPanel Orientation="Horizontal" Margin="0,20,0,0">
                <TextBlock Text="稀有度效果:" VerticalAlignment="Center"/>
                <ComboBox SelectedItem="{Binding SelectedPreset}" Margin="10,0,0,0">
                    <ComboBoxItem Content="普通"/>
                    <ComboBoxItem Content="稀有"/>
                    <ComboBoxItem Content="史诗"/>
                    <ComboBoxItem Content="传说"/>
                </ComboBox>
            </StackPanel>
        </StackPanel>
    </Grid>
</Window>
```

## 六、最佳实践

### 6.1 性能优化

```csharp
// 1. 对于大量卡牌，只对可见的启用流光
private void OnScrollChanged(object sender, ScrollChangedEventArgs e)
{
    foreach (var card in VisibleCards)
    {
        card.GlowRenderer.IsGlowEnabled = true;
    }
    foreach (var card in HiddenCards)
    {
        card.GlowRenderer.IsGlowEnabled = false;
    }
}

// 2. 使用适当尺寸的图片
// 推荐：200x300 到 400x600 之间

// 3. 对于静态展示，可以降低刷新率
// （需要修改 CardGlowDraw 内部实现）
```

### 6.2 错误处理

```csharp
// 验证配置
var config = new CardGlowConfig { BrightnessThreshold = 2.0f }; // 无效值
if (!config.Validate(out var error))
{
    Console.WriteLine($"配置无效: {error}");
    config = CardGlowConfig.Default; // 使用默认配置
}

// 处理图片加载失败
try
{
    GlowRenderer.Source = new Bitmap(imagePath);
}
catch (Exception ex)
{
    Console.WriteLine($"图片加载失败: {ex.Message}");
    // 使用占位图
    GlowRenderer.Source = PlaceholderImage;
}
```

### 6.3 响应式设计

```xml
<!-- 根据窗口大小调整卡牌尺寸 -->
<card:CardGlowRenderer 
    Source="{Binding CardImage}"
    Width="{Binding #Root.Bounds.Width, Converter={StaticResource SizeConverter}}"
    Height="{Binding #Root.Bounds.Height, Converter={StaticResource SizeConverter}}"/>
```

## 七、常见问题

### Q1: 流光效果不显示？

**可能原因**：
1. GPU 不支持 - 检查是否有独立显卡
2. `IsGlowEnabled` 为 false
3. 图片未正确加载

**解决方案**：
```csharp
// 检查状态
Console.WriteLine($"IsGlowEnabled: {renderer.IsGlowEnabled}");
Console.WriteLine($"Source: {renderer.Source != null}");

// 强制刷新
renderer.ForceRefresh();
```

### Q2: 流光效果太强/太弱？

**解决方案**：调整 `OverallIntensity` 参数
```csharp
var config = CardGlowConfig.Default.Clone();
config.OverallIntensity = 0.5f;  // 降低强度
renderer.Config = config;
```

### Q3: 某些区域不发光？

**解决方案**：降低 `BrightnessThreshold`
```csharp
var config = CardGlowConfig.Default.Clone();
config.BrightnessThreshold = 0.4f;  // 降低阈值
renderer.Config = config;
```

### Q4: 性能问题？

**解决方案**：
1. 减小图片尺寸
2. 对不可见的卡牌禁用流光
3. 使用 `Subtle` 预设（效果简单，性能更好）

## 八、版本兼容

| 组件 | 最低版本 |
|------|----------|
| Avalonia | 11.0+ |
| SkiaSharp | 2.88+ |
| .NET | 6.0+ |

## 九、示例项目

完整示例请参考 `CardCollection` 页面的实现：
- `MFAAvalonia/Views/Pages/CardCollection.axaml`
- `MFAAvalonia/Views/Pages/CardCollection.axaml.cs`
