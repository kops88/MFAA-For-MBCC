# 卡牌流光特效代码结构详解

> 本文档详细解析流光特效的代码结构，帮助开发者理解每个类的职责和实现细节。

## 一、文件概览

```
MFAAvalonia/Views/UserControls/Card/
├── CardGlowRenderer.cs      # 主控件 + 内部渲染器
├── CardGlowConfig.cs        # 配置类 + 预设
└── CardGlowShader.sksl      # Shader 源码（参考文件）
```

## 二、CardGlowRenderer.cs 详解

### 2.1 类结构

```csharp
public class CardGlowRenderer : Control
{
    // 1. 依赖属性
    // 2. 私有字段
    // 3. Shader 代码
    // 4. 生命周期方法
    // 5. 更新方法
    // 6. 公共方法
    // 7. 内部渲染类 CardGlowDraw
}
```

### 2.2 依赖属性

```csharp
/// <summary>
/// 卡牌图像 - 要显示的图片
/// </summary>
public static readonly StyledProperty<IImage?> SourceProperty =
    AvaloniaProperty.Register<CardGlowRenderer, IImage?>(nameof(Source));

/// <summary>
/// 流光配置 - 控制效果参数
/// </summary>
public static readonly StyledProperty<CardGlowConfig> ConfigProperty =
    AvaloniaProperty.Register<CardGlowRenderer, CardGlowConfig>(
        nameof(Config), 
        defaultValue: CardGlowConfig.Default);

/// <summary>
/// 是否启用流光 - 开关
/// </summary>
public static readonly StyledProperty<bool> IsGlowEnabledProperty =
    AvaloniaProperty.Register<CardGlowRenderer, bool>(
        nameof(IsGlowEnabled), 
        defaultValue: true);
```

**使用方式**：
```xml
<card:CardGlowRenderer 
    Source="{Binding CardImage}"
    Config="{Binding GlowConfig}"
    IsGlowEnabled="True"/>
```

### 2.3 私有字段

```csharp
private CompositionCustomVisual? _customVisual;  // 合成视觉对象
private CardGlowDraw? _visualHandler;            // 渲染处理器
private SKBitmap? _sourceBitmap;                 // SkiaSharp 位图
private bool _needsImageUpdate = true;           // 图像更新标记
```

### 2.4 生命周期方法

#### 2.4.1 附加到视觉树

```csharp
protected override void OnAttachedToVisualTree(VisualTreeAttachmentEventArgs e)
{
    base.OnAttachedToVisualTree(e);
    InitializeVisual();  // 初始化渲染系统
}
```

#### 2.4.2 从视觉树分离

```csharp
protected override void OnDetachedFromVisualTree(VisualTreeAttachmentEventArgs e)
{
    base.OnDetachedFromVisualTree(e);
    CleanupResources();  // 清理资源
}
```

#### 2.4.3 属性变化处理

```csharp
protected override void OnPropertyChanged(AvaloniaPropertyChangedEventArgs change)
{
    base.OnPropertyChanged(change);
    
    if (change.Property == BoundsProperty)
        UpdateVisualSize();           // 尺寸变化
    else if (change.Property == SourceProperty)
        OnSourceChanged();            // 图像变化
    else if (change.Property == ConfigProperty)
        OnConfigChanged();            // 配置变化
    else if (change.Property == IsGlowEnabledProperty)
        OnGlowEnabledChanged();       // 开关变化
}
```

### 2.5 初始化流程

```csharp
private void InitializeVisual()
{
    // 1. 获取 Compositor
    var comp = ElementComposition.GetElementVisual(this)?.Compositor;
    if (comp == null) return;
    
    // 2. 创建渲染处理器
    _visualHandler = new CardGlowDraw();
    
    // 3. 创建合成视觉对象
    _customVisual = comp.CreateCustomVisual(_visualHandler);
    
    // 4. 设置为子视觉
    ElementComposition.SetElementChildVisual(this, _customVisual);
    
    // 5. 启动动画
    _customVisual.SendHandlerMessage(CardGlowDraw.StartAnimations);
    
    // 6. 更新配置和图像
    UpdateConfig();
    UpdateSourceBitmap();
    UpdateVisualSize();
}
```

### 2.6 图像转换

Avalonia 的 `Bitmap` 需要转换为 SkiaSharp 的 `SKBitmap`：

```csharp
private static SKBitmap? ConvertToSKBitmap(Bitmap bitmap)
{
    // 1. 创建内存流
    using var memoryStream = new MemoryStream();
    
    // 2. 将 Avalonia Bitmap 保存到流（PNG 格式）
    bitmap.Save(memoryStream);
    memoryStream.Position = 0;
    
    // 3. 从流中解码为 SKBitmap
    var skBitmap = SKBitmap.Decode(memoryStream);
    return skBitmap;
}
```

### 2.7 公共方法

```csharp
/// <summary>
/// 应用预设配置
/// </summary>
public void ApplyPreset(GlowPreset preset)
{
    Config = preset switch
    {
        GlowPreset.Default => CardGlowConfig.Default,
        GlowPreset.GoldRare => CardGlowConfig.GoldRare,
        // ... 其他预设
    };
}

/// <summary>
/// 强制刷新渲染
/// </summary>
public void ForceRefresh()
{
    _needsImageUpdate = true;
    UpdateSourceBitmap();
    UpdateConfig();
}
```

## 三、CardGlowDraw 内部类详解

### 3.1 类定义

```csharp
private class CardGlowDraw : CompositionCustomVisualHandler
{
    // 消息对象
    public static readonly object StartAnimations = new();
    public static readonly object StopAnimations = new();
    
    // 状态
    private readonly Stopwatch _animationTick = new();
    private bool _animationEnabled;
    
    // 资源
    private SKBitmap? _sourceBitmap;
    private SKShader? _imageShader;
    private SKRuntimeEffect? _effect;
    private CardGlowConfig _config;
    
    // 预分配数组（避免 GC）
    private readonly float[] _resolutionAlloc = new float[3];
    private readonly float[] _flowColorAlloc = new float[3];
    // ...
}
```

### 3.2 Shader 编译

```csharp
private void CompileShader()
{
    // 1. 添加基础 uniform（SukiUI 标准）
    var shaderCode = @"
uniform float iTime;
uniform float iAlpha;
uniform vec3 iResolution;
" + GlowShaderCode;  // 拼接主 Shader 代码
    
    // 2. 编译 Shader
    _effect = SKRuntimeEffect.CreateShader(shaderCode, out var errors);
    
    if (_effect == null)
        Debug.WriteLine($"Shader compilation failed: {errors}");
}
```

### 3.3 消息处理

```csharp
public override void OnMessage(object message)
{
    if (message == StartAnimations)
    {
        _animationEnabled = true;
        _animationTick.Start();
        RegisterForNextAnimationFrameUpdate();  // 注册下一帧回调
    }
    else if (message == StopAnimations)
    {
        _animationEnabled = false;
        _animationTick.Stop();
    }
}
```

### 3.4 动画帧更新

```csharp
public override void OnAnimationFrameUpdate()
{
    if (!_animationEnabled) return;
    
    Invalidate(GetRenderBounds());              // 标记需要重绘
    RegisterForNextAnimationFrameUpdate();      // 注册下一帧
}
```

### 3.5 渲染方法

```csharp
public override void OnRender(ImmediateDrawingContext context)
{
    // 1. 获取 SkiaSharp 接口
    var leaseFeature = context.TryGetFeature<ISkiaSharpApiLeaseFeature>();
    if (leaseFeature == null) return;
    
    using var lease = leaseFeature.Lease();
    var rect = SKRect.Create((float)EffectiveSize.X, (float)EffectiveSize.Y);
    
    // 2. 检查 GPU 是否可用
    if (lease.GrContext == null || _effect == null || _imageShader == null)
    {
        RenderSoftware(lease.SkCanvas, rect);  // 软件回退
    }
    else
    {
        Render(lease.SkCanvas, rect);          // GPU 渲染
    }
}
```

### 3.6 GPU 渲染实现

```csharp
private void Render(SKCanvas canvas, SKRect rect)
{
    // 1. 获取时间
    var time = (float)_animationTick.Elapsed.TotalSeconds;
    
    // 2. 更新分辨率数组
    _resolutionAlloc[0] = rect.Width;
    _resolutionAlloc[1] = rect.Height;
    _resolutionAlloc[2] = 0;
    
    // 3. 创建 Uniform（传递参数到 Shader）
    var uniforms = new SKRuntimeEffectUniforms(_effect)
    {
        { "iTime", time },
        { "iAlpha", 1.0f },
        { "iResolution", _resolutionAlloc },
        { "iBrightnessThreshold", _config.BrightnessThreshold },
        // ... 所有配置参数
    };
    
    // 4. 创建子 Shader（图像输入）
    var children = new SKRuntimeEffectChildren(_effect)
    {
        { "iImage", _imageShader }
    };
    
    // 5. 创建最终 Shader
    using var shader = _effect.ToShader(uniforms, children);
    
    // 6. 绘制
    using var paint = new SKPaint { Shader = shader };
    canvas.DrawRect(rect, paint);
}
```

## 四、CardGlowConfig.cs 详解

### 4.1 参数分类

```csharp
public class CardGlowConfig
{
    #region 亮度检测参数
    public float BrightnessThreshold { get; set; } = 0.65f;  // 亮度阈值
    public float SaturationThreshold { get; set; } = 0.3f;   // 饱和度阈值
    public float BrightnessWeight { get; set; } = 0.7f;      // 亮度权重
    public float SaturationWeight { get; set; } = 0.3f;      // 饱和度权重
    #endregion
    
    #region 流光效果参数
    public float FlowSpeed { get; set; } = 0.5f;             // 流光速度
    public float FlowWidth { get; set; } = 0.3f;             // 流光宽度
    public float FlowAngle { get; set; } = 0.785f;           // 流光角度（弧度）
    public float FlowIntensity { get; set; } = 0.8f;         // 流光强度
    #endregion
    
    #region 闪烁效果参数
    public bool EnableSparkle { get; set; } = true;
    public float SparkleFrequency { get; set; } = 3.0f;
    public float SparkleIntensity { get; set; } = 0.3f;
    public float SparkleDensity { get; set; } = 0.5f;
    #endregion
    
    #region 颜色参数
    public Color FlowColor { get; set; } = Color.FromRgb(255, 250, 240);
    public Color SecondaryFlowColor { get; set; } = Color.FromRgb(200, 220, 255);
    public Color SparkleColor { get; set; } = Color.FromRgb(255, 255, 255);
    #endregion
    
    #region 混合参数
    public int BlendMode { get; set; } = 1;                  // 0=Add, 1=Screen, 2=Overlay
    public float OverallIntensity { get; set; } = 1.0f;      // 整体强度
    #endregion
}
```

### 4.2 预设配置

```csharp
/// <summary>
/// 金色稀有卡配置
/// </summary>
public static CardGlowConfig GoldRare => new()
{
    BrightnessThreshold = 0.6f,
    FlowColor = Color.FromRgb(255, 215, 0),        // 金色
    SecondaryFlowColor = Color.FromRgb(255, 180, 50),
    EdgeGlowColor = Color.FromRgb(255, 200, 100),
    FlowIntensity = 1.0f,
    SparkleIntensity = 0.5f,
    GoldHueWeight = 0.5f
};

/// <summary>
/// 蓝色稀有卡配置
/// </summary>
public static CardGlowConfig BlueRare => new()
{
    BrightnessThreshold = 0.55f,
    FlowColor = Color.FromRgb(100, 180, 255),      // 蓝色
    SecondaryFlowColor = Color.FromRgb(150, 200, 255),
    BlueHueWeight = 0.4f
};
```

### 4.3 辅助方法

```csharp
/// <summary>
/// 将颜色转换为 Shader 使用的 float 数组
/// </summary>
public static float[] ColorToFloatArray(Color color)
{
    return new float[]
    {
        color.R / 255f,  // 转换为 0-1 范围
        color.G / 255f,
        color.B / 255f
    };
}

/// <summary>
/// 验证配置参数
/// </summary>
public bool Validate(out string errorMessage)
{
    if (BrightnessThreshold < 0 || BrightnessThreshold > 1)
    {
        errorMessage = "BrightnessThreshold must be between 0 and 1";
        return false;
    }
    // ... 其他验证
    return true;
}

/// <summary>
/// 克隆配置
/// </summary>
public CardGlowConfig Clone()
{
    return new CardGlowConfig
    {
        BrightnessThreshold = BrightnessThreshold,
        // ... 复制所有属性
    };
}
```

## 五、GlowPreset 枚举

```csharp
public enum GlowPreset
{
    Default,        // 默认效果
    GoldRare,       // 金色稀有卡
    BlueRare,       // 蓝色稀有卡
    PurpleLegend,   // 紫色传说卡
    RainbowHolo,    // 彩虹全息卡
    Subtle          // 低调效果
}
```

## 六、Shader 代码结构

### 6.1 Uniform 声明

```glsl
// 基础参数（由 Avalonia 提供）
uniform float iTime;           // 时间（秒）
uniform float iAlpha;          // 透明度
uniform vec3 iResolution;      // 分辨率

// 图像输入
uniform shader iImage;         // 卡牌图像

// 亮度检测参数
uniform float iBrightnessThreshold;
uniform float iSaturationThreshold;
// ...

// 流光效果参数
uniform float iFlowSpeed;
uniform float iFlowWidth;
// ...

// 颜色参数
uniform vec3 iFlowColor;
uniform vec3 iSecFlowColor;
// ...
```

### 6.2 主函数结构

```glsl
vec4 main(vec2 fragCoord) {
    // 1. 坐标归一化
    vec2 uv = fragCoord / iResolution.xy;
    
    // 2. 采样原图
    vec4 originalColor = iImage.eval(fragCoord);
    
    // 3. 计算发光遮罩
    float glowMask = calculateGlowMask(originalColor.rgb);
    
    // 4. 早期退出优化
    if (glowMask < 0.01) return originalColor;
    
    // 5. 计算流光效果
    vec3 mainFlowColor = ...;
    vec3 secFlowColor = ...;
    vec3 sparkleColor = ...;
    
    // 6. 合成
    vec3 totalGlow = (mainFlowColor + secFlowColor + sparkleColor) * glowMask;
    vec3 finalColor = blendColors(originalColor.rgb, totalGlow, iBlendMode);
    
    return vec4(finalColor, originalColor.a * iAlpha);
}
```

## 七、类图

```
┌─────────────────────────────────────────┐
│           CardGlowRenderer              │
│         (extends Control)               │
├─────────────────────────────────────────┤
│ + Source: IImage?                       │
│ + Config: CardGlowConfig                │
│ + IsGlowEnabled: bool                   │
├─────────────────────────────────────────┤
│ - _customVisual: CompositionCustomVisual│
│ - _visualHandler: CardGlowDraw          │
│ - _sourceBitmap: SKBitmap               │
├─────────────────────────────────────────┤
│ + ApplyPreset(preset)                   │
│ + ForceRefresh()                        │
│ - InitializeVisual()                    │
│ - UpdateSourceBitmap()                  │
│ - UpdateConfig()                        │
└─────────────────────────────────────────┘
                    │
                    │ contains
                    ▼
┌─────────────────────────────────────────┐
│             CardGlowDraw                │
│  (extends CompositionCustomVisualHandler)│
├─────────────────────────────────────────┤
│ - _animationTick: Stopwatch             │
│ - _effect: SKRuntimeEffect              │
│ - _imageShader: SKShader                │
│ - _config: CardGlowConfig               │
├─────────────────────────────────────────┤
│ + OnMessage(message)                    │
│ + OnAnimationFrameUpdate()              │
│ + OnRender(context)                     │
│ - Render(canvas, rect)                  │
│ - RenderSoftware(canvas, rect)          │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│           CardGlowConfig                │
├─────────────────────────────────────────┤
│ + BrightnessThreshold: float            │
│ + FlowSpeed: float                      │
│ + FlowColor: Color                      │
│ + BlendMode: int                        │
│ + ...                                   │
├─────────────────────────────────────────┤
│ + static Default: CardGlowConfig        │
│ + static GoldRare: CardGlowConfig       │
│ + static BlueRare: CardGlowConfig       │
│ + ...                                   │
├─────────────────────────────────────────┤
│ + Validate(out error): bool             │
│ + Clone(): CardGlowConfig               │
│ + static ColorToFloatArray(color)       │
└─────────────────────────────────────────┘
```

## 八、数据流图

```
用户操作
    │
    ▼
┌─────────────────┐
│ 设置 Source     │ ──→ OnSourceChanged() ──→ UpdateSourceBitmap()
│ 设置 Config     │ ──→ OnConfigChanged() ──→ UpdateConfig()
│ 设置 IsEnabled  │ ──→ OnGlowEnabledChanged() ──→ Start/Stop
└─────────────────┘
                                                    │
                                                    ▼
                                          ┌─────────────────┐
                                          │ CardGlowDraw    │
                                          │ SetSourceBitmap │
                                          │ SetConfig       │
                                          └─────────────────┘
                                                    │
                                                    ▼
                                          ┌─────────────────┐
                                          │ 每帧渲染循环    │
                                          │ OnAnimationFrame│
                                          │ OnRender        │
                                          └─────────────────┘
                                                    │
                                                    ▼
                                          ┌─────────────────┐
                                          │ GPU Shader      │
                                          │ 执行流光效果    │
                                          └─────────────────┘
```
